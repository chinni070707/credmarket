{% extends 'base.html' %}

{% block title %}{{ listing.title }} - CredMarket{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Breadcrumb -->
    <nav class="flex mb-6 text-sm text-gray-600">
        <a href="{% url 'listings:home' %}" class="hover:text-green-600">Home</a>
        <span class="mx-2">/</span>
        <a href="{% url 'listings:category_listings' listing.category.slug %}" class="hover:text-green-600">{{ listing.category.name }}</a>
        <span class="mx-2">/</span>
        <span class="text-gray-900">{{ listing.title|truncatewords:5 }}</span>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Content -->
        <div class="lg:col-span-2">
            <!-- Image Gallery -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-6" x-data="{ currentImage: 0 }">
                <!-- Main Image -->
                <div class="relative h-96 bg-gray-200">
                    {% if listing.images.all %}
                        {% for image in listing.images.all %}
                        <img 
                            src="{{ image.image.url }}" 
                            alt="{{ listing.title }}"
                            class="w-full h-full object-contain"
                            x-show="currentImage === {{ forloop.counter0 }}"
                        >
                        {% endfor %}
                    {% else %}
                        <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-green-100 to-emerald-100">
                            <i class="fas fa-image text-9xl text-gray-300"></i>
                        </div>
                    {% endif %}
                    
                    <!-- Status Badge -->
                    <div class="absolute top-4 left-4">
                        {% if listing.status == 'sold' %}
                        <span class="bg-red-500 text-white px-4 py-2 rounded-full font-bold">
                            <i class="fas fa-check-circle mr-1"></i> SOLD
                        </span>
                        {% elif listing.is_featured %}
                        <span class="bg-yellow-400 text-green-900 px-4 py-2 rounded-full font-bold">
                            <i class="fas fa-star mr-1"></i> FEATURED
                        </span>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Thumbnails -->
                {% if listing.images.count > 1 %}
                <div class="p-4 flex space-x-2 overflow-x-auto">
                    {% for image in listing.images.all %}
                    <button 
                        @click="currentImage = {{ forloop.counter0 }}"
                        class="flex-shrink-0 w-20 h-20 rounded-lg overflow-hidden border-2 transition"
                        :class="currentImage === {{ forloop.counter0 }} ? 'border-green-500' : 'border-gray-300'"
                    >
                        <img src="{{ image.image.url }}" alt="Thumbnail" class="w-full h-full object-cover">
                    </button>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- Details -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h1 class="text-3xl font-bold text-gray-900 mb-4">{{ listing.title }}</h1>
                
                <!-- Price & Info -->
                <div class="flex flex-wrap items-center gap-4 mb-6 pb-6 border-b">
                    <div class="text-4xl font-bold text-green-600">₹{{ listing.price }}</div>
                    {% if listing.is_negotiable %}
                    <span class="bg-green-100 text-green-700 px-4 py-2 rounded-full font-semibold">
                        <i class="fas fa-handshake mr-1"></i> Negotiable
                    </span>
                    {% endif %}
                    <span class="bg-green-100 text-green-700 px-4 py-2 rounded-full font-semibold">
                        {{ listing.get_condition_display }}
                    </span>
                </div>

                <!-- Description -->
                <div class="mb-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-3">Description</h2>
                    <p class="text-gray-700 leading-relaxed whitespace-pre-line">{{ listing.description }}</p>
                </div>

                <!-- Specifications -->
                <div class="grid grid-cols-2 gap-4 bg-gray-50 rounded-lg p-4">
                    <div>
                        <div class="text-sm text-gray-600 mb-1">Category</div>
                        <div class="font-semibold text-gray-900">{{ listing.category.name }}</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-600 mb-1">Condition</div>
                        <div class="font-semibold text-gray-900">{{ listing.get_condition_display }}</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-600 mb-1">Location</div>
                        <div class="font-semibold text-gray-900">{{ listing.city }}, {{ listing.state }}</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-600 mb-1">Posted</div>
                        <div class="font-semibold text-gray-900">{{ listing.created_at|timesince }} ago</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="lg:col-span-1">
            <!-- Seller Card -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6 sticky top-20">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Seller Information</h3>
                
                <div class="flex items-center space-x-4 mb-6">
                    {% if listing.seller.profile_picture %}
                        <img src="{{ listing.seller.profile_picture.url }}" alt="{{ listing.seller.get_display_name }}" class="w-16 h-16 rounded-full">
                    {% else %}
                        <div class="w-16 h-16 bg-gradient-to-r from-green-500 to-emerald-500 rounded-full flex items-center justify-center text-white text-2xl font-bold">
                            {% if listing.seller.show_real_name %}
                                {{ listing.seller.first_name.0 }}{{ listing.seller.last_name.0 }}
                            {% else %}
                                {{ listing.seller.get_display_name.0 }}
                            {% endif %}
                        </div>
                    {% endif %}
                    <div>
                        <div class="font-bold text-gray-900">{{ listing.seller.get_display_name }}</div>
                        {% if listing.seller.company %}
                        <div class="text-sm text-gray-600">{{ listing.seller.company.name }}</div>
                        {% endif %}
                        <div class="flex items-center text-sm text-green-600 mt-1">
                            <i class="fas fa-shield-check mr-1"></i> Verified Employee
                        </div>
                    </div>
                </div>

                {% if user.is_authenticated %}
                    {% if user == listing.seller %}
                        <!-- Own Listing Actions -->
                        <div class="space-y-3">
                            <a href="{% url 'listings:edit_listing' listing.slug %}" class="block w-full bg-green-600 hover:bg-green-700 text-white text-center py-3 rounded-lg font-semibold transition">
                                <i class="fas fa-edit mr-2"></i> Edit Listing
                            </a>
                            <a href="{% url 'listings:delete_listing' listing.slug %}" class="block w-full bg-red-600 hover:bg-red-700 text-white text-center py-3 rounded-lg font-semibold transition">
                                <i class="fas fa-trash mr-2"></i> Delete Listing
                            </a>
                        </div>
                    {% else %}
                        <!-- Contact Seller -->
                        <a href="{% url 'messaging:start_conversation' listing.slug %}" class="block w-full btn-primary text-white text-center py-4 rounded-lg font-bold text-lg mb-3">
                            <i class="fas fa-comment-dots mr-2"></i> Contact Seller
                        </a>
                        <button class="block w-full border-2 border-purple-600 text-green-600 hover:bg-purple-50 text-center py-3 rounded-lg font-semibold transition">
                            <i class="fas fa-heart mr-2"></i> Save for Later
                        </button>
                    {% endif %}
                {% else %}
                    <a href="{% url 'accounts:login' %}" class="block w-full btn-primary text-white text-center py-4 rounded-lg font-bold text-lg">
                        Login to Contact Seller
                    </a>
                {% endif %}

                <!-- Stats -->
                <div class="mt-6 pt-6 border-t grid grid-cols-2 gap-4 text-center">
                    <div>
                        <div class="text-2xl font-bold text-green-600">{{ listing.views_count }}</div>
                        <div class="text-sm text-gray-600">Views</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-green-600">{{ listing.seller.listings.count }}</div>
                        <div class="text-sm text-gray-600">Listings</div>
                    </div>
                </div>
            </div>

            <!-- Safety Tips -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4">
                <h4 class="font-bold text-gray-900 mb-2 flex items-center">
                    <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i> Safety Tips
                </h4>
                <ul class="text-sm text-gray-700 space-y-2">
                    <li><i class="fas fa-check text-green-600 mr-2"></i> Meet in public places</li>
                    <li><i class="fas fa-check text-green-600 mr-2"></i> Check item before payment</li>
                    <li><i class="fas fa-check text-green-600 mr-2"></i> Never share sensitive info</li>
                    <li><i class="fas fa-check text-green-600 mr-2"></i> Report suspicious activity</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Related Listings -->
    {% if related_listings %}
    <div class="mt-12">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Similar Listings</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            {% for item in related_listings %}
            <a href="{% url 'listings:listing_detail' item.slug %}" class="group">
                <div class="bg-white rounded-xl shadow-md overflow-hidden card-hover">
                    <div class="relative h-40 bg-gray-200 overflow-hidden">
                        {% if item.get_primary_image %}
                            <img src="{{ item.get_primary_image.image.url }}" alt="{{ item.title }}" class="w-full h-full object-cover group-hover:scale-110 transition">
                        {% else %}
                            <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-green-100 to-emerald-100">
                                <i class="fas fa-image text-4xl text-gray-300"></i>
                            </div>
                        {% endif %}
                    </div>
                    <div class="p-4">
                        <h3 class="font-bold text-gray-900 mb-2 line-clamp-2">{{ item.title }}</h3>
                        <div class="text-xl font-bold text-green-600">₹{{ item.price }}</div>
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
